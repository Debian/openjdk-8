Description: Handle EXTRA_* flags into icedtea
 - Use -J-Xbootclasspath for javac of PulseAudio
 - Append $EXTRA_CFLAGS_IT to $IT_CFLAGS (use for PulseAudio native build)
 - Append $EXTRA_LDFLAGS_IT to PulseAudio native link
 - Send all EXTRA_* flags to jamvm and cacao
 - Remove `-icedtea' from the release identifier
 - Rename hotspot source and debian patches for zerovm build
 - Add x32 configure bits
Author: Damien Raude-Morvan <drazzib@debian.org>, Matthias Klose <doko@ubuntu.com>
 
--- Makefile.am
+++ Makefile.am
@@ -150,7 +150,7 @@
 IT_JAVACFLAGS=$(IT_JAVAC_SETTINGS) -source $(IT_LANGUAGE_SOURCE_VERSION) -target $(IT_CLASS_TARGET_VERSION)
 
 # Flags
-IT_CFLAGS=$(CFLAGS) $(ARCHFLAG)
+IT_CFLAGS=$(CFLAGS) $(ARCHFLAG) $(EXTRA_CFLAGS_IT)
 
 # Conditional defintions
 
@@ -1521,9 +1521,6 @@
 	  echo "DISTRO_PACKAGE_VERSION=$(PKGVERSION)" \
 	    >>openjdk/jdk/make/common/shared/Defs.gmk ;
 endif
-	if test x"$(PROJECT_NAME)" != "xjdk7" && test x"$(PROJECT_NAME)" != "xicedtea"; then \
-	  proj_suffix="-$(PROJECT_NAME)"; \
-	fi ; \
 	if test x"$(VERSION_SUFFIX)" != "x"; then \
 	  ver_suffix="-$(VERSION_SUFFIX)"; \
 	fi ; \
@@ -2215,7 +2212,7 @@
 	 -I$(PULSE_JAVA_NATIVE_BUILDDIR) -o $@ -c $<
 
 $(PULSE_JAVA_NATIVE_BUILDDIR)/libpulse-java.so: $(PULSE_JAVA_NATIVE_OBJECTS)
-	$(CC) $(LDFLAGS) -shared $(PULSE_JAVA_NATIVE_OBJECTS) $(LIBPULSE_LIBS) \
+	$(CC) $(LDFLAGS) $(EXTRA_LDFLAGS_IT) -shared $(PULSE_JAVA_NATIVE_OBJECTS) $(LIBPULSE_LIBS) \
 	 -o $(PULSE_JAVA_NATIVE_BUILDDIR)/libpulse-java.so
 
 endif
@@ -2283,7 +2280,8 @@
 if BUILD_JAMVM
 	cd jamvm/jamvm && \
 	./autogen.sh --with-java-runtime-library=openjdk7 \
-	  --prefix=$(abs_top_builddir)/jamvm/install ; \
+	  --prefix=$(abs_top_builddir)/jamvm/install \
+	  CFLAGS='$(EXTRA_CFLAGS_JAMVM)' LDFLAGS='$(EXTRA_LDFLAGS_JAMVM)' CPPFLAGS='$(EXTRA_CPPFLAGS_JAMVM)' CXXFLAGS='$(EXTRA_CXXFLAGS_JAMVM)'; \
 	$(MAKE) ; \
 	$(MAKE) install
 	mkdir -p $(abs_top_builddir)/jamvm/install/hotspot/jre/lib/$(INSTALL_ARCH_DIR)/server
@@ -2352,7 +2350,8 @@
 	  --with-java-runtime-library=openjdk7 \
 	  --with-java-runtime-library-prefix=$(abs_top_builddir)/openjdk \
 	  --with-java-runtime-library-classes=$(RUNTIME) \
-	  --enable-jre-layout $(CACAO_CONFIGURE_ARGS); \
+	  --enable-jre-layout $(CACAO_CONFIGURE_ARGS) \
+	  CFLAGS='$(EXTRA_CFLAGS_CACAO)' LDFLAGS='$(EXTRA_LDFLAGS_CACAO)' CPPFLAGS='$(EXTRA_CPPFLAGS_CACAO)' CXXFLAGS='$(EXTRA_CXXFLAGS_CACAO)'; \
 	$(ARCH_PREFIX) $(MAKE) -j$(PARALLEL_JOBS) install
 	ln -sf server $(abs_top_builddir)/cacao/install/jre/lib/$(INSTALL_ARCH_DIR)/client
 	touch $(abs_top_builddir)/cacao/install/jre/lib/$(INSTALL_ARCH_DIR)/server/Xusage.txt
@@ -2428,7 +2427,7 @@
 			'--with-javac=% '--with-javac=% \
 			'--with-rmic=% '--with-additional-vms=% \
 			'--disable-bootstrap% '--enable-bootstrap% , \
-		$(CONFIGURE_ARGS)) \
+		$(subst hotspot-default.tar,hotspot-zero.tar,$(CONFIGURE_ARGS))) \
 	$(foreach i, openjdk hotspot corba jaxp jaxws jdk langtools, \
 	  $(if $(findstring --with-$(i)-src-zip=, $(CONFIGURE_ARGS)),, --with-$(i)-src-zip=$(abs_top_builddir)/$(i).tar.gz))
 
@@ -2438,7 +2437,7 @@
 	BUILD_JAXWS=false     ALT_JAXWS_DIST=$(BUILD_OUTPUT_DIR)/jaxws/dist \
 	BUILD_CORBA=false     ALT_CORBA_DIST=$(BUILD_OUTPUT_DIR)/corba/dist \
 	BUILD_JDK=false \
-	DISTRIBUTION_PATCHES='$(foreach p,$(DISTRIBUTION_PATCHES),$(if $(findstring cacao,$(p)),,$(if $(findstring jamvm,$(p)),,$(p))))'
+	DISTRIBUTION_PATCHES='$(foreach p,$(subst -default,-zero,$(DISTRIBUTION_PATCHES)),$(if $(findstring cacao,$(p)),,$(if $(findstring jamvm,$(p)),,$(p))))'
 
 stamps/add-zero.stamp: stamps/icedtea.stamp
 	mkdir -p stamps
--- Makefile.in
+++ Makefile.in
@@ -637,7 +637,7 @@
 IT_JAVACFLAGS = $(IT_JAVAC_SETTINGS) -source $(IT_LANGUAGE_SOURCE_VERSION) -target $(IT_CLASS_TARGET_VERSION)
 
 # Flags
-IT_CFLAGS = $(CFLAGS) $(ARCHFLAG)
+IT_CFLAGS = $(CFLAGS) $(ARCHFLAG) $(EXTRA_CFLAGS_IT)
 @USE_HG_FALSE@OPENJDK_SRC_ZIP = openjdk.tar.gz
 
 # Conditional defintions
@@ -988,9 +988,10 @@
 	--disable-docs $(filter-out '--with-jdk-home=% '--with-ecj=% \
 	'--with-java=% '--with-javah=% '--with-javac=% '--with-javac=% \
 	'--with-rmic=% '--with-additional-vms=% '--disable-bootstrap% \
-	'--enable-bootstrap% , $(CONFIGURE_ARGS)) $(foreach i, openjdk \
-	hotspot corba jaxp jaxws jdk langtools, $(if $(findstring \
-	--with-$(i)-src-zip=, $(CONFIGURE_ARGS)),, \
+	'--enable-bootstrap% , $(subst \
+	hotspot-default.tar,hotspot-zero.tar,$(CONFIGURE_ARGS))) \
+	$(foreach i, openjdk hotspot corba jaxp jaxws jdk langtools, \
+	$(if $(findstring --with-$(i)-src-zip=, $(CONFIGURE_ARGS)),, \
 	--with-$(i)-src-zip=$(abs_top_builddir)/$(i).tar.gz))
 ADD_ZERO_EXTRA_BUILD_ENV = \
 	BUILD_LANGTOOLS=false ALT_LANGTOOLS_DIST=$(BUILD_OUTPUT_DIR)/langtools/dist \
@@ -998,7 +999,7 @@
 	BUILD_JAXWS=false     ALT_JAXWS_DIST=$(BUILD_OUTPUT_DIR)/jaxws/dist \
 	BUILD_CORBA=false     ALT_CORBA_DIST=$(BUILD_OUTPUT_DIR)/corba/dist \
 	BUILD_JDK=false \
-	DISTRIBUTION_PATCHES='$(foreach p,$(DISTRIBUTION_PATCHES),$(if $(findstring cacao,$(p)),,$(if $(findstring jamvm,$(p)),,$(p))))'
+	DISTRIBUTION_PATCHES='$(foreach p,$(subst -default,-zero,$(DISTRIBUTION_PATCHES)),$(if $(findstring cacao,$(p)),,$(if $(findstring jamvm,$(p)),,$(p))))'
 
 
 # FIXME: this might need some adjustment for other OS than Linux
@@ -2019,9 +2020,6 @@
 	echo "DISTRO_NAME=$(DIST_NAME)" >>openjdk/jdk/make/common/shared/Defs.gmk ;
 @HAS_PKGVERSION_TRUE@	  echo "DISTRO_PACKAGE_VERSION=$(PKGVERSION)" \
 @HAS_PKGVERSION_TRUE@	    >>openjdk/jdk/make/common/shared/Defs.gmk ;
-	if test x"$(PROJECT_NAME)" != "xjdk7" && test x"$(PROJECT_NAME)" != "xicedtea"; then \
-	  proj_suffix="-$(PROJECT_NAME)"; \
-	fi ; \
 	if test x"$(VERSION_SUFFIX)" != "x"; then \
 	  ver_suffix="-$(VERSION_SUFFIX)"; \
 	fi ; \
@@ -2649,7 +2647,7 @@
 @ENABLE_PULSE_JAVA_TRUE@	 -I$(PULSE_JAVA_NATIVE_BUILDDIR) -o $@ -c $<
 
 @ENABLE_PULSE_JAVA_TRUE@$(PULSE_JAVA_NATIVE_BUILDDIR)/libpulse-java.so: $(PULSE_JAVA_NATIVE_OBJECTS)
-@ENABLE_PULSE_JAVA_TRUE@	$(CC) $(LDFLAGS) -shared $(PULSE_JAVA_NATIVE_OBJECTS) $(LIBPULSE_LIBS) \
+@ENABLE_PULSE_JAVA_TRUE@	$(CC) $(LDFLAGS) $(EXTRA_LDFLAGS_IT) -shared $(PULSE_JAVA_NATIVE_OBJECTS) $(LIBPULSE_LIBS) \
 @ENABLE_PULSE_JAVA_TRUE@	 -o $(PULSE_JAVA_NATIVE_BUILDDIR)/libpulse-java.so
 
 clean-pulse-java:
@@ -2710,7 +2708,8 @@
 stamps/jamvm.stamp: $(OPENJDK_TREE) stamps/rt.stamp
 @BUILD_JAMVM_TRUE@	cd jamvm/jamvm && \
 @BUILD_JAMVM_TRUE@	./autogen.sh --with-java-runtime-library=openjdk7 \
-@BUILD_JAMVM_TRUE@	  --prefix=$(abs_top_builddir)/jamvm/install ; \
+@BUILD_JAMVM_TRUE@	  --prefix=$(abs_top_builddir)/jamvm/install \
+@BUILD_JAMVM_TRUE@	  CFLAGS='$(EXTRA_CFLAGS_JAMVM)' LDFLAGS='$(EXTRA_LDFLAGS_JAMVM)' CPPFLAGS='$(EXTRA_CPPFLAGS_JAMVM)' CXXFLAGS='$(EXTRA_CXXFLAGS_JAMVM)'; \
 @BUILD_JAMVM_TRUE@	$(MAKE) ; \
 @BUILD_JAMVM_TRUE@	$(MAKE) install
 @BUILD_JAMVM_TRUE@	mkdir -p $(abs_top_builddir)/jamvm/install/hotspot/jre/lib/$(INSTALL_ARCH_DIR)/server
@@ -2770,7 +2769,8 @@
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  --with-java-runtime-library=openjdk7 \
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  --with-java-runtime-library-prefix=$(abs_top_builddir)/openjdk \
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  --with-java-runtime-library-classes=$(RUNTIME) \
-@BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  --enable-jre-layout $(CACAO_CONFIGURE_ARGS); \
+@BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  --enable-jre-layout $(CACAO_CONFIGURE_ARGS) \
+@BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	  CFLAGS='$(EXTRA_CFLAGS_CACAO)' LDFLAGS='$(EXTRA_LDFLAGS_CACAO)' CPPFLAGS='$(EXTRA_CPPFLAGS_CACAO)' CXXFLAGS='$(EXTRA_CXXFLAGS_CACAO)'; \
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	$(ARCH_PREFIX) $(MAKE) -j$(PARALLEL_JOBS) install
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	ln -sf server $(abs_top_builddir)/cacao/install/jre/lib/$(INSTALL_ARCH_DIR)/client
 @BUILD_CACAO_TRUE@@USE_SYSTEM_CACAO_FALSE@	touch $(abs_top_builddir)/cacao/install/jre/lib/$(INSTALL_ARCH_DIR)/server/Xusage.txt
--- acinclude.m4
+++ acinclude.m4
@@ -2,10 +2,18 @@
 [
   case "${host_cpu}" in
     x86_64)
-      BUILD_ARCH_DIR=amd64
-      INSTALL_ARCH_DIR=amd64
-      JRE_ARCH_DIR=amd64
-      ARCHFLAG="-m64"
+      case "${host}" in
+        *x32)
+          BUILD_ARCH_DIR=x32
+          INSTALL_ARCH_DIR=x32
+          JRE_ARCH_DIR=x32
+          ;;
+        *)
+          BUILD_ARCH_DIR=amd64
+          INSTALL_ARCH_DIR=amd64
+          JRE_ARCH_DIR=amd64
+          ARCHFLAG="-m64"
+      esac
       ;;
     i?86)
       BUILD_ARCH_DIR=i586
@@ -702,10 +710,10 @@
   ZERO_LIBARCH="${INSTALL_ARCH_DIR}"
   dnl can't use AC_CHECK_SIZEOF on multilib
   case "${ZERO_LIBARCH}" in
-    arm|i386|ppc|s390|sh|sparc)
+    arm|i386|ppc|s390|sh|sparc|x32)
       ZERO_BITSPERWORD=32
       ;;
-    aarch64|alpha|amd64|ia64|ppc64|s390x|sparcv9)
+    aarch64|alpha|amd64|ia64|ppc64*|s390x|sparcv9)
       ZERO_BITSPERWORD=64
       ;;
     *)
@@ -1954,7 +1962,7 @@
   AC_MSG_RESULT(${ENABLE_SYSTEM_LCMS})
   if test x"${ENABLE_SYSTEM_LCMS}" = "xyes"; then
     dnl Check for LCMS2 headers and libraries.
-    PKG_CHECK_MODULES(LCMS2, lcms2 >= 2.5,[LCMS2_FOUND=yes],[LCMS2_FOUND=no])
+    PKG_CHECK_MODULES(LCMS2, lcms2,[LCMS2_FOUND=yes],[LCMS2_FOUND=no])
     if test "x${LCMS2_FOUND}" = xno
     then
       AC_MSG_ERROR([Could not find LCMS >= 2.5; install it or build with --disable-system-lcms to use the in-tree copy.])
--- configure
+++ configure
@@ -7300,10 +7300,18 @@
 
   case "${host_cpu}" in
     x86_64)
-      BUILD_ARCH_DIR=amd64
-      INSTALL_ARCH_DIR=amd64
-      JRE_ARCH_DIR=amd64
-      ARCHFLAG="-m64"
+      case "${host}" in
+        *x32)
+          BUILD_ARCH_DIR=x32
+          INSTALL_ARCH_DIR=x32
+          JRE_ARCH_DIR=x32
+          ;;
+        *)
+          BUILD_ARCH_DIR=amd64
+          INSTALL_ARCH_DIR=amd64
+          JRE_ARCH_DIR=amd64
+          ARCHFLAG="-m64"
+      esac
       ;;
     i?86)
       BUILD_ARCH_DIR=i586
@@ -7904,10 +7912,10 @@
 
   ZERO_LIBARCH="${INSTALL_ARCH_DIR}"
     case "${ZERO_LIBARCH}" in
-    arm|i386|ppc|s390|sh|sparc)
+    arm|i386|ppc|s390|sh|sparc|x32)
       ZERO_BITSPERWORD=32
       ;;
-    aarch64|alpha|amd64|ia64|ppc64|s390x|sparcv9)
+    aarch64|alpha|amd64|ia64|ppc64*|s390x|sparcv9)
       ZERO_BITSPERWORD=64
       ;;
     *)
@@ -9044,10 +9052,18 @@
 
   case "${host_cpu}" in
     x86_64)
-      BUILD_ARCH_DIR=amd64
-      INSTALL_ARCH_DIR=amd64
-      JRE_ARCH_DIR=amd64
-      ARCHFLAG="-m64"
+      case "${host}" in
+        *x32)
+          BUILD_ARCH_DIR=x32
+          INSTALL_ARCH_DIR=x32
+          JRE_ARCH_DIR=x32
+          ;;
+        *)
+          BUILD_ARCH_DIR=amd64
+          INSTALL_ARCH_DIR=amd64
+          JRE_ARCH_DIR=amd64
+          ARCHFLAG="-m64"
+      esac
       ;;
     i?86)
       BUILD_ARCH_DIR=i586
@@ -13396,12 +13412,12 @@
     pkg_cv_LCMS2_CFLAGS="$LCMS2_CFLAGS"
  elif test -n "$PKG_CONFIG"; then
     if test -n "$PKG_CONFIG" && \
-    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"lcms2 >= 2.5\""; } >&5
-  ($PKG_CONFIG --exists --print-errors "lcms2 >= 2.5") 2>&5
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"lcms2\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "lcms2") 2>&5
   ac_status=$?
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
-  pkg_cv_LCMS2_CFLAGS=`$PKG_CONFIG --cflags "lcms2 >= 2.5" 2>/dev/null`
+  pkg_cv_LCMS2_CFLAGS=`$PKG_CONFIG --cflags "lcms2" 2>/dev/null`
 		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
@@ -13413,12 +13429,12 @@
     pkg_cv_LCMS2_LIBS="$LCMS2_LIBS"
  elif test -n "$PKG_CONFIG"; then
     if test -n "$PKG_CONFIG" && \
-    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"lcms2 >= 2.5\""; } >&5
-  ($PKG_CONFIG --exists --print-errors "lcms2 >= 2.5") 2>&5
+    { { $as_echo "$as_me:${as_lineno-$LINENO}: \$PKG_CONFIG --exists --print-errors \"lcms2\""; } >&5
+  ($PKG_CONFIG --exists --print-errors "lcms2") 2>&5
   ac_status=$?
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
-  pkg_cv_LCMS2_LIBS=`$PKG_CONFIG --libs "lcms2 >= 2.5" 2>/dev/null`
+  pkg_cv_LCMS2_LIBS=`$PKG_CONFIG --libs "lcms2" 2>/dev/null`
 		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
@@ -13439,9 +13455,9 @@
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        LCMS2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "lcms2 >= 2.5" 2>&1`
+	        LCMS2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "lcms2" 2>&1`
         else
-	        LCMS2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "lcms2 >= 2.5" 2>&1`
+	        LCMS2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "lcms2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$LCMS2_PKG_ERRORS" >&5
